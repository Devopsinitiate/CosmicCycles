{% extends 'base.html' %}

{% block content %}
    {% if not user_profile.date_of_birth %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
        <p class="font-bold">Welcome!</p>
        <p>Please <a href="{% url 'edit_profile' %}" class="font-bold underline">add your date of birth</a> to calculate your personalized cycles.</p>
    </div>
    {% endif %}

    <!-- Header -->
    <header class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-blue-400 mb-4">COSMIC CYCLES</h1>
        <p class="text-xl text-purple-200 max-w-3xl mx-auto">Align with the universe's natural rhythms for celestial success</p>
        <div class="mt-6 flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4">
            <button id="dailyBtn" data-cycle="daily" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-500 text-white rounded-full hover:from-purple-700 hover:to-blue-600 transition-all shadow-lg shadow-purple-500/20"><i class="fas fa-sun mr-2"></i>Daily</button>
            <button id="yearlyBtn" data-cycle="yearly" class="px-6 py-2 bg-gray-800 text-purple-300 rounded-full hover:bg-gray-700 transition-all border border-purple-900 hover:border-purple-600"><i class="fas fa-calendar-alt mr-2"></i>Yearly</button>
            <button id="businessBtn" data-cycle="business" class="px-6 py-2 bg-gray-800 text-purple-300 rounded-full hover:bg-gray-700 transition-all border border-purple-900 hover:border-purple-600"><i class="fas fa-briefcase mr-2"></i>Business</button>
            <button id="soulBtn" data-cycle="soul" class="px-6 py-2 bg-gray-800 text-purple-300 rounded-full hover:bg-gray-700 transition-all border border-purple-900 hover:border-purple-600"><i class="fas fa-heart mr-2"></i>Soul</button>
            <button id="healthBtn" data-cycle="health" class="px-6 py-2 bg-gray-800 text-purple-300 rounded-full hover:bg-gray-700 transition-all border border-purple-900 hover:border-purple-600"><i class="fas fa-heartbeat mr-2"></i>Health</button>
            <button id="reincarnationBtn" data-cycle="reincarnation" class="px-6 py-2 bg-gray-800 text-purple-300 rounded-full hover:bg-gray-700 transition-all border border-purple-900 hover:border-purple-600"><i class="fas fa-infinity mr-2"></i>Reincarnation</button>
        </div>
        <div class="mt-4 flex justify-center space-x-3">
            <a href="{% url 'edit_profile' %}" class="px-4 py-2 bg-white text-indigo-700 rounded shadow hover:bg-gray-100">Edit profile</a>
            <a href="{% url 'business_list' %}" class="px-4 py-2 bg-white text-indigo-700 rounded shadow hover:bg-gray-100">Manage businesses</a>
        </div>

        <!-- Inline Profile Edit Modal -->
        <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 md:w-1/2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Edit profile</h3>
                    <button id="closeProfileModal" class="text-gray-600">Close</button>
                </div>
                <form id="profileModalForm" data-url="{% url 'profile_update_api' %}">
                    {% csrf_token %}
                    {{ user_profile_form.as_p }}
                    <div class="flex justify-end mt-4">
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </header>

    <!-- Current Time Display -->
    <div class="bg-gray-800 bg-opacity-70 backdrop-blur-md rounded-xl shadow-lg p-6 mb-8 text-center border border-purple-900">
        <div class="flex justify-center items-center space-x-4 mb-4">
            <i class="fas fa-clock text-purple-400 text-2xl"></i>
            <h2 class="text-2xl font-semibold text-purple-100" id="currentDateTime">Loading...</h2>
        </div>
        <div id="currentCycleInfo" class="max-w-2xl mx-auto">
            <!-- Will be filled by JavaScript -->
        </div>
    </div>

    <!-- Human Life Cycle Summary -->
    <div class="bg-gray-800 bg-opacity-60 rounded-lg p-4 mb-6 border border-purple-800">
        <h3 class="text-lg text-purple-200 font-semibold">Human Life Cycle</h3>
        {% if current_human_period %}
        <p class="text-gray-300">Current: <span id="humanCurrentName">{{ current_human_period.name }}</span> (Age range: <span id="humanCurrentRange">{{ current_human_period.start_age }} - {{ current_human_period.end_age }}</span>)</p>
        <div class="w-full bg-gray-700 h-3 rounded mt-2 overflow-hidden">
            <div class="bg-purple-600 h-full" data-progress="{{ human_progress }}"></div>
        </div>
        {% else %}
        <p class="text-gray-400">Birth date not set. Please set your birth date in profile to see your human life cycle.</p>
        {% endif %}
    </div>
    <div class="mb-6 flex justify-center">
        <!-- compact SVG progress ring -- container is square; JS will render the ring inside -->
        <div id="cycleRing" class="w-36 h-36"></div>
    </div>

    

    <!-- Full template modal -->
    <div id="fullTemplateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 md:w-2/3 lg:max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-semibold">Period Details</h3>
                <button id="closeModal" class="text-gray-600">Close</button>
            </div>
            <div id="modalBody" class="text-gray-800 dark:text-gray-200 overflow-y-auto" style="max-height: 70vh;"></div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="contentArea">
        <!-- Daily Cycle (Default View) -->
        <div id="dailyContent" class="cycle-content">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for period in daily_periods %}
                <div class="cycle-card bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl shadow-lg p-6 border border-purple-800 {% if period.name == current_daily_period.name %}period-active{% endif %}" data-period-details='{"name": "{{ period.name }}", "start": "{{ period.start }}", "end": "{{ period.end }}", "principle": "{{ period.principle }}", "suggestion": "{{ period.suggestion }}"}'>
                    <div class="flex items-center mb-4">
                        <div class="p-3 rounded-full bg-purple-500 text-white mr-4">
                            <i class="fas fa-sun text-lg"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white">{{ period.name }}</h3>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center text-sm text-purple-300">
                            <i class="far fa-clock mr-2"></i>
                            <span>{{ period.start }} - {{ period.end }}</span>
                        </div>
                        <div class="text-purple-200">
                            <p class="font-medium">Principle:</p>
                            <p>{{ period.principle }}</p>
                        </div>
                        <div class="text-purple-200">
                            <p class="font-medium">Suggested Activities:</p>
                            <p>{{ period.suggestion }}</p>
                        </div>
                    </div>
                    {% if period.name == current_daily_period.name %}<div class="mt-4 py-2 px-4 bg-purple-700 text-white rounded-lg text-center font-medium">Current Period</div>{% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Yearly Cycle (Hidden by default) -->
        <div id="yearlyContent" class="cycle-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold text-indigo-900 mb-4">Your Yearly Cycle</h2>
                <div class="flex flex-col md:flex-row items-center mb-6">
                    <div class="w-full md:w-1/3 mb-4 md:mb-0">
                        <form method="post">
                            {% csrf_token %}
                            {{ user_profile_form.as_p }}
                            <button type="submit" class="mt-3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Save</button>
                        </form>
                    </div>
                    <div class="w-full md:w-2/3 md:pl-8">
                        <div id="yearlyProgress" class="relative w-full h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div id="yearlyProgressBar" class="h-full bg-indigo-600 rounded-full" data-progress="{{ yearly_progress }}"></div>
                        </div>
                        <div id="yearlyStatus" class="mt-4 text-lg text-indigo-800 font-medium">{{ current_yearly_period.name }}</div>
                        <div id="yearlyDescription" class="mt-2 text-gray-600">{{ current_yearly_period.principle }}<br><em>Suggestion: {{ current_yearly_period.suggestion }}</em></div>
                    </div>
                </div>
                <div id="yearlyPeriods" class="space-y-4">
                    {% for period in yearly_periods %}
                    <div class="cycle-card bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl shadow-lg p-6 border border-purple-800 {% if period.name == current_yearly_period.name %}period-active{% endif %}" data-period-details='{"name": "{{ period.name }}", "principle": "{{ period.principle }}", "suggestion": "{{ period.suggestion }}", "start_date": "{{ period.start_date|date:"M d, Y" }}", "end_date": "{{ period.end_date|date:"M d, Y" }}", "full_description": "{{ period.full_description|escapejs }}"}'>
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-purple-500 text-white mr-4">
                                <i class="fas fa-calendar-alt text-lg"></i>
                            </div>
                            <h4 class="font-semibold text-lg text-white">{{ period.name }}</h4>
                        </div>
                        <div class="text-sm text-purple-300">
                            <span>{{ period.start_date|date:"M d, Y" }} - {{ period.end_date|date:"M d, Y" }}</span>
                        </div>
                        <p class="text-purple-200">{{ period.principle }}</p>
                        <p class="text-purple-300 mt-1"><em>Suggestion: {{ period.suggestion }}</em></p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Business Cycle (Hidden by default) -->
        <div id="businessContent" class="cycle-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold text-indigo-900 mb-4">Business Cycles</h2>
                <div class="mb-4">
                    <label for="businessSelect" class="sr-only">Preview business</label>
                    <select id="businessSelect" class="w-full md:w-1/2 border border-gray-300 rounded px-3 py-2">
                        <option value="">Select a business to preview</option>
                        {% for b in businesses %}
                        <option value="{{ b.id }}">{{ b.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-6">
                    <form method="post">
                        {% csrf_token %}
                        {{ business_form.as_p }}
                        <button type="submit" class="mt-3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Add Business</button>
                    </form>
                </div>
                <div id="businessPeriods" class="space-y-4">
                    {% for cycle in business_cycles %}
                    <div class="cycle-card bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl shadow-lg p-6 border border-purple-800 {% if cycle.current_period.name == cycle.current_period.name %}period-active{% endif %}" data-period-details='{"name": "{{ cycle.current_period.name }}", "principle": "{{ cycle.current_period.principle }}", "suggestion": "{{ cycle.current_period.suggestion }}", "start_date": "{{ cycle.current_period.start_date|date:"M d, Y" }}", "end_date": "{{ cycle.current_period.end_date|date:"M d, Y" }}", "full_description": "{{ cycle.full_description|escapejs }}"}'>
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-purple-500 text-white mr-4">
                                <i class="fas fa-briefcase text-lg"></i>
                            </div>
                            <h3 class="font-semibold text-lg text-white">{{ cycle.business.name }}</h3>
                        </div>
                        <div class="text-sm text-purple-300">
                            <span>{{ cycle.current_period.start_date|date:"M d, Y" }} - {{ cycle.current_period.end_date|date:"M d, Y" }}</span>
                        </div>
                        <div class="relative w-full h-4 bg-gray-700 rounded-full overflow-hidden mt-2">
                            <div class="h-full bg-purple-600 rounded-full" data-progress="{{ cycle.progress }}"></div>
                        </div>
                        <div class="mt-2 text-lg text-white font-medium">{{ cycle.current_period.name }}</div>
                        <p class="text-purple-200">{{ cycle.current_period.principle }}</p>
                        <p class="text-purple-300 mt-1"><em>Suggestion: {{ cycle.current_period.suggestion }}</em></p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Soul Cycle (Hidden by default) -->
        <div id="soulContent" class="cycle-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-indigo-900 mb-4">Soul Cycle</h2>
                <div class="flex flex-col md:flex-row items-center mb-8">
                    <div class="w-full md:w-1/3 flex justify-center mb-4 md:mb-0">
                        <div class="relative w-40 h-40">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="8"/>
                                <circle id="soulProgressCircle" cx="50" cy="50" r="45" fill="none" stroke="#6366f1" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="{{ soul_progress_offset }}" data-progress="{{ soul_progress|floatformat:0 }}" class="progress-ring__circle"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="soulProgressText" class="text-2xl font-bold text-indigo-700" data-progress="{{ soul_progress|floatformat:0 }}">{{ soul_progress|floatformat:0 }}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3 md:pl-8">
                        <div id="soulStatus" class="text-xl font-semibold text-indigo-800 mb-2">{{ current_soul_period.name }}</div>
                        <div id="soulDates" class="text-gray-600 mb-3">{{ current_soul_period.start_date.1 }}/{{ current_soul_period.start_date.0 }} - {{ current_soul_period.end_date.1 }}/{{ current_soul_period.end_date.0 }}</div>
                        <div id="soulDescription" class="text-gray-700">{{ current_soul_period.principle }}</div>
                    </div>
                </div>
                <div id="soulPeriods" class="space-y-4">
                    {% for period in soul_periods %}
                    <div class="cycle-card bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl shadow-lg p-6 border border-purple-800 {% if period.name == current_soul_period.name %}period-active{% endif %}" data-period-details='{"name": "{{ period.name }}", "principle": "{{ period.principle }}", "suggestion": "{{ period.suggestion }}", "start_date": "{{ period.start_date|date:"M d, Y" }}", "end_date": "{{ period.end_date|date:"M d, Y" }}", "full_description": "{{ period.full_description|escapejs }}"}'>
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-purple-500 text-white mr-4">
                                <i class="fas fa-heart text-lg"></i>
                            </div>
                            <h4 class="font-semibold text-lg text-white">{{ period.name }}</h4>
                        </div>
                        <div class="text-sm text-purple-300">
                            <span>{{ period.start_date|date:"M d, Y" }} - {{ period.end_date|date:"M d, Y" }}</span>
                        </div>
                        <p class="text-purple-200">{{ period.principle }}</p>
                        <p class="text-purple-300 mt-1"><em>Suggestion: {{ period.suggestion }}</em></p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Health Cycle (Hidden by default) -->
        <div id="healthContent" class="cycle-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold text-indigo-900 mb-4">Your Health Cycle</h2>
                <div id="healthPeriods" class="space-y-4">
                    {% for period in health_periods %}
                    <div class="cycle-card bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl shadow-lg p-6 border border-purple-800 {% if period.name == current_health_period.name %}period-active{% endif %}" data-period-details='{"name": "{{ period.name }}", "principle": "{{ period.principle }}", "suggestion": "{{ period.suggestion }}", "start_date": "{{ period.start_date|date:"M d, Y" }}", "end_date": "{{ period.end_date|date:"M d, Y" }}", "full_description": "{{ period.full_description|escapejs }}"}'>
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-purple-500 text-white mr-4">
                                <i class="fas fa-heartbeat text-lg"></i>
                            </div>
                            <h4 class="font-semibold text-lg text-white">{{ period.name }}</h4>
                        </div>
                        <div class="text-sm text-purple-300">
                            <span>{{ period.start_date|date:"M d, Y" }} - {{ period.end_date|date:"M d, Y" }}</span>
                        </div>
                        <p class="text-purple-200">{{ period.principle }}</p>
                        <p class="text-purple-300 mt-1"><em>Suggestion: {{ period.suggestion }}</em></p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Reincarnation Cycle (Hidden by default) -->
        <div id="reincarnationContent" class="cycle-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold text-indigo-900 mb-4">Your Reincarnation Cycle</h2>
                <div id="reincarnationPeriods" class="space-y-4">
                    {% for period in reincarnation_periods %}
                    <div class="cycle-card bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl shadow-lg p-6 border border-purple-800 {% if period.name == current_reincarnation_period.name %}period-active{% endif %}" data-period-details='{"name": "{{ period.name }}", "principle": "{{ period.principle }}", "suggestion": "{{ period.suggestion }}", "start_date": "{{ period.start_date|date:"M d, Y" }}", "end_date": "{{ period.end_date|date:"M d, Y" }}", "full_description": "{{ period.full_description|escapejs }}"}'>
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-purple-500 text-white mr-4">
                                <i class="fas fa-infinity text-lg"></i>
                            </div>
                            <h4 class="font-semibold text-lg text-white">{{ period.name }}</h4>
                        </div>
                        <div class="text-sm text-purple-300">
                            <span>{{ period.start_date|date:"M d, Y" }} - {{ period.end_date|date:"M d, Y" }}</span>
                        </div>
                        <p class="text-purple-200">{{ period.principle }}</p>
                        <p class="text-purple-300 mt-1"><em>Suggestion: {{ period.suggestion }}</em></p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {% load static %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'cycles/js/human_cycle.js' %}"></script>
    {% endblock %}